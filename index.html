<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Text Encoding and Decoding with Image</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: Arial, Helvetica, sans-serif;
    }

    button {
      font-size: 20px;
    }

    #text-input {
      width: 90dvw;
      max-width: 500px;
      height: 50dvw;
      max-height: 250px;
      font-size: 20px;
    }

    #download-link {
      text-decoration: none;
      text-align: center;
      color: #0075ff;
      padding: 5px;
      padding-left: 20px;
      padding-right: 20px;
      border-radius: 20px;
      background: #eee;
      display: none;
      font-size: 20px;
    }

    #decoded-text {
      white-space: pre-wrap;
      font-size: 20px;
    }

    #edit {
      display: none;
    }
  </style>
</head>

<body>
  <h1>Tpenxgt</h1>
  <textarea type="text" id="text-input"></textarea>
  <button onclick="encodeText()">Encode</button>
  <canvas id="canvas" width="200" height="200" style="border: 1px solid #ccc;"></canvas>
  <a id="download-link" href="#" download="encoded-image.png">Download</a>
  <input type="file" id="upload-input" accept="image/png">
  <button onclick="decodeText()">Decode</button>
  <button id="edit">Edit</button>
  <p id="decoded-text"></p>

  <script>
    function encodeText() {
      const text = document.getElementById('text-input').value;
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const imageData = ctx.createImageData(canvas.width, canvas.height);
      const data = imageData.data;
      canvas.width = 200;
      canvas.height = 200;
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

      const textLength = Math.min(text.length, canvas.width * canvas.height);
      for (let i = 0; i < textLength; i++) {
        const charCode = text.charCodeAt(i);
        const x = i % canvas.width;
        const y = Math.floor(i / canvas.width);
        const index = (y * canvas.width + x) * 4;

        data[index] = (charCode >> 16) & 0xFF; // Red
        data[index + 1] = (charCode >> 8) & 0xFF; // Green
        data[index + 2] = charCode & 0xFF; // Blue
        data[index + 3] = 255; // Alpha
      }

      ctx.putImageData(imageData, 0, 0);

      // Crop the image to remove transparent or white parts
      const croppedImageData = cropCanvas(canvas);

      const link = document.getElementById('download-link');
      const imageDataUrl = croppedImageData.toDataURL('image/png');

      link.href = imageDataUrl;
      link.style.display = 'block';
    }

    function decodeText() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const uploadInput = document.getElementById('upload-input');
      const file = uploadInput.files[0];
      const reader = new FileReader();

      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          // Crop the image to remove transparent or white parts
          const croppedCanvas = cropCanvas(canvas);
          canvas.width = croppedCanvas.width;
          canvas.height = croppedCanvas.height;
          ctx.drawImage(croppedCanvas, 0, 0);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          let text = '';

          for (let i = 0; i < data.length; i += 4) {
            const red = data[i];
            const green = data[i + 1];
            const blue = data[i + 2];
            const charCode = (red << 16) | (green << 8) | blue;
            if (charCode === 0) break; // Stop at null character

            text += String.fromCharCode(charCode);
          }

          document.getElementById('decoded-text').innerHTML = text + `Text: ${textSizeInKB(text)}kb File: ${fileSizeInKB(file)}kb`;
          document.getElementById('edit').style.display = 'block';
          document.getElementById('edit').onclick = () => {
            document.getElementById('text-input').value = text;
            document.getElementById('decoded-text').innerHTML = '';
            document.getElementById('edit').style.display = '';
          };
        }
        img.onerror = function() {
          alert('Failed to load image.');
        }
        img.src = event.target.result;
      }

      reader.onerror = function() {
        alert('Failed to read file.');
      }

      if (file) {
        reader.readAsDataURL(file);
      } else {
        alert('Please upload an image.');
      }
    }

    function cropCanvas(canvas) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;

      let top = height;
      let bottom = 0;
      let left = width;
      let right = 0;

      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const index = (y * width + x) * 4;
          if (data[index + 3] > 0) {
            top = Math.min(top, y);
            bottom = Math.max(bottom, y);
            left = Math.min(left, x);
            right = Math.max(right, x);
          }
        }
      }

      const croppedWidth = right - left + 1;
      const croppedHeight = bottom - top + 1;
      const croppedCanvas = document.createElement('canvas');
      croppedCanvas.width = croppedWidth;
      croppedCanvas.height = croppedHeight;
      const croppedCtx = croppedCanvas.getContext('2d');
      croppedCtx.drawImage(canvas, left, top, croppedWidth, croppedHeight, 0, 0, croppedWidth, croppedHeight);

      return croppedCanvas;
    }

    function textSizeInKB(text) {
      // 使用 Blob 來計算文字的大小
      const blob = new Blob([text], { type: 'text/plain' });
      // 將大小轉換為 KB
      const sizeInKB = blob.size / 1024;
      return sizeInKB.toFixed(2); // 保留兩位小數
    }

    function fileSizeInKB(file) {
      // 獲取檔案的大小（以字節為單位）
      const sizeInBytes = file.size;
      // 將大小轉換為 KB
      const sizeInKB = sizeInBytes / 1024;
      return sizeInKB.toFixed(2); // 保留兩位小數
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function() {
        console.log('Text copied to clipboard successfully!');
      }, function(err) {
        console.error('Unable to copy text to clipboard', err);
      });
    }
  </script>
</body>

</html>